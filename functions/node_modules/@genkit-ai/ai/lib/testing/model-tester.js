"use strict";
var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(
  // If the importer is in node compatibility mode or this is not an ESM
  // file that has been converted to a CommonJS file using a Babel-
  // compatible transform (i.e. "__esModule" has not been set), then set
  // "default" to the CommonJS "module.exports" for node compatibility.
  isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target,
  mod
));
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);
var __async = (__this, __arguments, generator) => {
  return new Promise((resolve, reject) => {
    var fulfilled = (value) => {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    };
    var rejected = (value) => {
      try {
        step(generator.throw(value));
      } catch (e) {
        reject(e);
      }
    };
    var step = (x) => x.done ? resolve(x.value) : Promise.resolve(x.value).then(fulfilled, rejected);
    step((generator = generator.apply(__this, __arguments)).next());
  });
};
var model_tester_exports = {};
__export(model_tester_exports, {
  testModels: () => testModels
});
module.exports = __toCommonJS(model_tester_exports);
var import_core = require("@genkit-ai/core");
var import_tracing = require("@genkit-ai/core/tracing");
var import_node_assert = __toESM(require("node:assert"));
var import_generate = require("../generate");
var import_tool = require("../tool");
const tests = {
  "basic hi": (registry, model) => __async(void 0, null, function* () {
    const response = yield (0, import_generate.generate)(registry, {
      model,
      prompt: 'just say "Hi", literally'
    });
    const got = response.text.trim();
    import_node_assert.default.match(got, /Hi/i);
  }),
  multimodal: (registry, model) => __async(void 0, null, function* () {
    var _a, _b;
    const resolvedModel = yield registry.lookupAction(
      `/model/${model}`
    );
    if (!((_b = (_a = resolvedModel.__action.metadata) == null ? void 0 : _a.model.supports) == null ? void 0 : _b.media)) {
      skip();
    }
    const response = yield (0, import_generate.generate)(registry, {
      model,
      prompt: [
        {
          media: {
            url: "data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAABhGlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9TpSoVETOIOGSoulgQFXHUKhShQqgVWnUwufRDaNKQtLg4Cq4FBz8Wqw4uzro6uAqC4AeIs4OToouU+L+k0CLGg+N+vLv3uHsHCLUi0+22MUA3ylYyHpPSmRUp9IpOhCCiFyMKs81ZWU7Ad3zdI8DXuyjP8j/35+jWsjYDAhLxDDOtMvE68dRm2eS8TyyygqIRnxOPWnRB4keuqx6/cc67LPBM0Uol54hFYinfwmoLs4KlE08SRzTdoHwh7bHGeYuzXqywxj35C8NZY3mJ6zQHEccCFiFDgooKNlBEGVFaDVJsJGk/5uMfcP0yuVRybYCRYx4l6FBcP/gf/O7Wzk2Me0nhGND+4jgfQ0BoF6hXHef72HHqJ0DwGbgymv5SDZj+JL3a1CJHQM82cHHd1NQ94HIH6H8yFUtxpSBNIZcD3s/omzJA3y3Qter11tjH6QOQoq4SN8DBITCcp+w1n3d3tPb275lGfz9aC3Kd0jYiSQAAAAlwSFlzAAAuIwAALiMBeKU/dgAAAAd0SU1FB+gJBxQRO1/5qB8AAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAsUlEQVQoz61SMQqEMBDcO5SYToUE/IBPyRMCftAH+INUviApUwYjNkKCVcTiQK7IHSw45czODrMswCOQUkopEQZjzDiOWemdZfu+b5oGYYgx1nWNMPwB2vACAK01Y4wQ8qGqqirL8jzPlNI9t64r55wQUgBA27be+xDCfaJhGJxzSqnv3UKIn7ne+2VZEB2stZRSRLN93+d5RiRs28Y5RySEEI7jyEpFlp2mqeu6Zx75ApQwPdsIcq0ZAAAAAElFTkSuQmCC"
          }
        },
        {
          text: "what math operation is this? plus, minus, multiply or divide?"
        }
      ]
    });
    const want = "";
    const got = response.text.trim();
    import_node_assert.default.match(got, /plus/i);
  }),
  history: (registry, model) => __async(void 0, null, function* () {
    var _a, _b;
    const resolvedModel = yield registry.lookupAction(
      `/model/${model}`
    );
    if (!((_b = (_a = resolvedModel.__action.metadata) == null ? void 0 : _a.model.supports) == null ? void 0 : _b.multiturn)) {
      skip();
    }
    const response1 = yield (0, import_generate.generate)(registry, {
      model,
      prompt: "My name is Glorb"
    });
    const response = yield (0, import_generate.generate)(registry, {
      model,
      prompt: "What's my name?",
      messages: response1.messages
    });
    const got = response.text.trim();
    import_node_assert.default.match(got, /Glorb/);
  }),
  "system prompt": (registry, model) => __async(void 0, null, function* () {
    const { text } = yield (0, import_generate.generate)(registry, {
      model,
      prompt: "Hi",
      messages: [
        {
          role: "system",
          content: [
            {
              text: 'If the user says "Hi", just say "Bye" '
            }
          ]
        }
      ]
    });
    const want = "Bye";
    const got = text.trim();
    import_node_assert.default.equal(got, want);
  }),
  "structured output": (registry, model) => __async(void 0, null, function* () {
    const response = yield (0, import_generate.generate)(registry, {
      model,
      prompt: "extract data as json from: Jack was a Lumberjack",
      output: {
        format: "json",
        schema: import_core.z.object({
          name: import_core.z.string(),
          occupation: import_core.z.string()
        })
      }
    });
    const want = {
      name: "Jack",
      occupation: "Lumberjack"
    };
    const got = response.output;
    import_node_assert.default.deepEqual(want, got);
  }),
  "tool calling": (registry, model) => __async(void 0, null, function* () {
    var _a, _b;
    const resolvedModel = yield registry.lookupAction(
      `/model/${model}`
    );
    if (!((_b = (_a = resolvedModel.__action.metadata) == null ? void 0 : _a.model.supports) == null ? void 0 : _b.tools)) {
      skip();
    }
    const { text } = yield (0, import_generate.generate)(registry, {
      model,
      prompt: "what is a gablorken of 2? use provided tool",
      tools: ["gablorkenTool"]
    });
    const got = text.trim();
    import_node_assert.default.match(got, /9.407/);
  })
};
function testModels(registry, models) {
  return __async(this, null, function* () {
    const gablorkenTool = (0, import_tool.defineTool)(
      registry,
      {
        name: "gablorkenTool",
        description: "use when need to calculate a gablorken",
        inputSchema: import_core.z.object({
          value: import_core.z.number()
        }),
        outputSchema: import_core.z.number()
      },
      (input) => __async(this, null, function* () {
        return Math.pow(input.value, 3) + 1.407;
      })
    );
    return yield (0, import_tracing.runInNewSpan)({ metadata: { name: "testModels" } }, () => __async(this, null, function* () {
      const report = [];
      for (const test of Object.keys(tests)) {
        yield (0, import_tracing.runInNewSpan)({ metadata: { name: test } }, () => __async(this, null, function* () {
          report.push({
            description: test,
            models: []
          });
          const caseReport = report[report.length - 1];
          for (const model of models) {
            caseReport.models.push({
              name: model,
              passed: true
              // optimistically
            });
            const modelReport = caseReport.models[caseReport.models.length - 1];
            try {
              yield tests[test](registry, model);
            } catch (e) {
              modelReport.passed = false;
              if (e instanceof SkipTestError) {
                modelReport.skipped = true;
              } else if (e instanceof Error) {
                modelReport.error = {
                  message: e.message,
                  stack: e.stack
                };
              } else {
                modelReport.error = {
                  message: `${e}`
                };
              }
            }
          }
        }));
      }
      return report;
    }));
  });
}
class SkipTestError extends Error {
}
function skip() {
  throw new SkipTestError();
}
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  testModels
});
//# sourceMappingURL=model-tester.js.map